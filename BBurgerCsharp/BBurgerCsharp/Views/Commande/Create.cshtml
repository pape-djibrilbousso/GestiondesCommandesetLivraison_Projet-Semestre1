@model BBurgerCsharp.Web.Models.ViewModels.CommandeViewModel

@{
    ViewData["Title"] = "Passer commande";
}

<h1 class="mb-4"><i class="fas fa-shopping-bag"></i> Finaliser ma commande</h1>

<div class="row">
    <div class="col-md-8">
        <form asp-action="Create" method="post">
            <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

            <!-- Type de livraison -->
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="fas fa-truck"></i> Type de livraison</h5>
                </div>
                <div class="card-body">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="radio" name="TypeLivraison" 
                               id="surPlace" value="sur_place" checked>
                        <label class="form-check-label" for="surPlace">
                            <i class="fas fa-utensils"></i> <strong>Sur place</strong>
                            <small class="text-muted d-block">À consommer au restaurant</small>
                        </label>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="radio" name="TypeLivraison" 
                               id="aEmporter" value="a_emporter">
                        <label class="form-check-label" for="aEmporter">
                            <i class="fas fa-box"></i> <strong>À emporter</strong>
                            <small class="text-muted d-block">À récupérer au restaurant</small>
                        </label>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="radio" name="TypeLivraison" 
                               id="livraison" value="livraison">
                        <label class="form-check-label" for="livraison">
                            <i class="fas fa-motorcycle"></i> <strong>Livraison</strong>
                            <small class="text-muted d-block">Livraison à domicile</small>
                        </label>
                    </div>
                    <span asp-validation-for="TypeLivraison" class="text-danger"></span>

                    <!-- Zone de livraison (visible seulement si livraison) -->
                    <div id="zoneSelection" style="display: none;" class="mt-3">
                        <label asp-for="ZoneId" class="form-label">Zone de livraison</label>
                        <select asp-for="ZoneId" class="form-select" id="zoneSelect">
                            <option value="">-- Sélectionnez une zone --</option>
                            @foreach (var zone in Model.ZonesDisponibles)
                            {
                                <option value="@zone.Id" data-prix="@zone.PrixLivraison">
                                    @zone.Nom - @zone.Quartiers (@zone.PrixFormate)
                                </option>
                            }
                        </select>
                        <span asp-validation-for="ZoneId" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <!-- Moyen de paiement -->
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="fas fa-credit-card"></i> Moyen de paiement</h5>
                </div>
                <div class="card-body">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="radio" name="MoyenPaiement" 
                               id="wave" value="Wave" checked>
                        <label class="form-check-label" for="wave">
                            <i class="fas fa-mobile-alt text-primary"></i> <strong>Wave</strong>
                        </label>
                    </div>

                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="MoyenPaiement" 
                               id="om" value="OM">
                        <label class="form-check-label" for="om">
                            <i class="fas fa-mobile-alt text-warning"></i> <strong>Orange Money</strong>
                        </label>
                    </div>
                    <span asp-validation-for="MoyenPaiement" class="text-danger"></span>
                </div>
            </div>

            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-danger btn-lg">
                    <i class="fas fa-check-circle"></i> Confirmer et Payer
                </button>
            </div>
        </form>
    </div>

    <!-- Récapitulatif de la commande -->
    <div class="col-md-4">
        <div class="card shadow sticky-top" style="top: 20px;">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-receipt"></i> Récapitulatif</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <span>Montant des produits :</span>
                    <strong id="montantProduits">@Model.MontantTotal.ToString("N0") FCFA</strong>
                </div>

                <div class="d-flex justify-content-between mb-2" id="fraisLivraisonRow" style="display: none;">
                    <span>Frais de livraison :</span>
                    <strong id="fraisLivraison">0 FCFA</strong>
                </div>

                <hr>

                <div class="d-flex justify-content-between mb-3">
                    <strong class="fs-5">Total à payer :</strong>
                    <strong class="text-danger fs-4" id="montantFinal">@Model.MontantTotal.ToString("N0") FCFA</strong>
                </div>

                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Le paiement sera effectué via le moyen choisi
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <script>
        const montantBase = @Model.MontantTotal;
        
        // Afficher/masquer la zone de livraison
        document.querySelectorAll('input[name="TypeLivraison"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const zoneSelection = document.getElementById('zoneSelection');
                const fraisRow = document.getElementById('fraisLivraisonRow');
                
                if (this.value === 'livraison') {
                    zoneSelection.style.display = 'block';
                } else {
                    zoneSelection.style.display = 'none';
                    fraisRow.style.display = 'none';
                    updateTotal(0);
                }
            });
        });
        
        // Calculer le total avec frais de livraison
        document.getElementById('zoneSelect')?.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const prixLivraison = parseFloat(selectedOption.dataset.prix || 0);
            
            if (prixLivraison > 0) {
                document.getElementById('fraisLivraisonRow').style.display = 'flex';
                document.getElementById('fraisLivraison').textContent = prixLivraison.toLocaleString('fr-FR') + ' FCFA';
                updateTotal(prixLivraison);
            } else {
                document.getElementById('fraisLivraisonRow').style.display = 'none';
                updateTotal(0);
            }
        });
        
        function updateTotal(frais) {
            const total = montantBase + frais;
            document.getElementById('montantFinal').textContent = total.toLocaleString('fr-FR') + ' FCFA';
        }
    </script>
}